# Form Example - Form Validation

Example using a form with custom validation plugin.

## Interactive Demo

::form-example
::

## Overview

This example illustrates:
- Using the **ValidationPlugin** to validate data
- Creating custom validation rules
- Managing errors per field
- Real-time validation
- Conditional form submission

## Architecture

### Parent Component: `FormExample.vue`

The parent component creates a desk with a validation plugin.

```vue
<script setup lang="ts">
import { useCheckIn, createValidationPlugin } from '@/vue-checkin/composables/useCheckIn';
import FormField from './FormField.vue';
import { FORM_DESK_KEY } from './index';

interface FieldData {
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
}

// Custom validation plugin
const validationPlugin = createValidationPlugin<FieldData>({
  validate: (data: FieldData) => {
    // Check if field is required
    if (data.required && !data.value) {
      return 'This field is required';
    }
    
    // Check email format
    if (data.type === 'email' && data.value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(data.value)) {
        return 'Invalid email';
      }
    }
    
    return true;
  },
});

// Create a desk with validation
const { createDesk } = useCheckIn<FieldData>();
const { desk } = createDesk(FORM_DESK_KEY, {
  debug: true,
  plugins: [validationPlugin],
});

// Extended typing for plugin methods
type DeskWithValidation = typeof desk & {
  isValid?: Ref<boolean>;
  getErrors?: () => Record<string | number, string>;
};

const deskWithValidation = desk as DeskWithValidation;
</script>
```

### Child Component: `FormField.vue`

Each field registers and synchronizes its data for validation.

```vue
<script setup lang="ts">
import { useCheckIn } from '@/vue-checkin/composables/useCheckIn';
import { FORM_DESK_KEY } from './index';

interface FormField {
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
}

const props = defineProps<{
  id: string | number;
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
  error?: string;
}>();

// Auto check-in with data watching
useCheckIn<FormField>().checkIn(FORM_DESK_KEY, {
  id: props.id,
  autoCheckIn: true,
  watchData: true,
  data: () => ({
    label: props.label,
    value: props.value,
    type: props.type,
    required: props.required,
  }),
});
</script>

<template>
  <div class="form-field">
    <label :for="String(id)" class="label">
      {{ label }}
      <span v-if="required" class="required">*</span>
    </label>
    <UInput
      :id="String(id)"
      :model-value="value"
      :type="type"
      :placeholder="`Enter ${label.toLowerCase()}`"
      @update:model-value="$emit('update', id, $event)"
    />
    <span v-if="error" class="error">
      {{ error }}
    </span>
  </div>
</template>
```

### InjectionKey: `index.ts`

```typescript
import type { InjectionKey } from 'vue';
import type { CheckInDesk } from '@/vue-checkin/composables/useCheckIn';

interface FieldData {
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
}

export const FORM_DESK_KEY: InjectionKey<CheckInDesk<FieldData>> = Symbol('formDesk');

export { default as FormExample } from './FormExample.vue';
export { default as FormField } from './FormField.vue';
```

## ValidationPlugin

### Méthodes ajoutées

- `isValid`: Ref booléen indiquant si tous les champs sont valides
- `getErrors()`: Retourne un objet avec les erreurs par champ ID

### Fonction de validation

```typescript
const validationPlugin = createValidationPlugin<FieldData>({
  validate: (data: FieldData) => {
    // Retourner true si valide
    if (isValid(data)) {
      return true;
    }
    
    // Return error message if invalid
    return 'Error message';
  },
});
```

## Features

### Real-time Validation

```typescript
const isFormValid = computed(() => deskWithValidation.isValid?.value ?? false);
const errors = computed(() => deskWithValidation.getErrors?.() || {});
```

Each field modification automatically triggers validation.

### Updating a Field

```typescript
const updateFieldValue = (id: string, value: string) => {
  const field = fieldsData.value.find(f => f.id === id);
  if (field) {
    field.value = value;
  }
};
```

Thanks to `watchData: true`, validation is triggered automatically.

### Form Submission

```typescript
const submitForm = () => {
  if (isFormValid.value) {
    const formData = fieldsData.value.reduce((acc, field) => {
      acc[field.id] = field.value;
      return acc;
    }, {} as Record<string, string>);

    alert('Form submitted successfully!\n\n' + JSON.stringify(formData, null, 2));
  } else {
    alert('The form contains errors. Please correct them.');
  }
};
```

### Reset

```typescript
const resetForm = () => {
  fieldsData.value.forEach((field) => {
    field.value = '';
  });
};
```

## Validation Rules

### Required Field

```typescript
if (data.required && !data.value) {
  return 'This field is required';
}
```

### Email Format

```typescript
if (data.type === 'email' && data.value) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(data.value)) {
    return 'Invalid email';
  }
}
```

### Custom Validation

```typescript
// Minimum number
if (data.type === 'number' && data.value) {
  const num = parseInt(data.value);
  if (num < 18) {
    return 'You must be at least 18 years old';
  }
}

// Minimum length
if (data.value.length < 3) {
  return 'Minimum 3 characters';
}

// Custom pattern
if (!/^[A-Z]/.test(data.value)) {
  return 'Must start with a capital letter';
}
```

## Key Concepts

::alert{type="info"}
**Reactive Validation**: Validation triggers automatically on each modification thanks to `watchData`.
::

::alert{type="info"}
**Global State**: `isValid` and `getErrors()` provide the complete validation state of the form.
::

::alert{type="success"}
**Custom Rules**: The plugin accepts any validation function.
::

## Usage

```vue
<template>
  <FormExample />
</template>

<script setup lang="ts">
import { FormExample } from '@/components/examples/form-example';
</script>
```

## Important Points

- Validation triggers on every data modification
- `isValid` is `true` only if **all** fields are valid
- Errors are indexed by field ID
- The `validate` function must return `true` or an error message (string)
- Combine with other plugins to add functionality (history, etc.)

## Extensions

### Asynchronous Validation

```typescript
const asyncValidationPlugin = createValidationPlugin<FieldData>({
  validate: async (data: FieldData) => {
    if (data.type === 'email') {
      const exists = await checkEmailExists(data.value);
      if (exists) {
        return 'This email is already in use';
      }
    }
    return true;
  },
});
```

### Conditional Validation

```typescript
const conditionalPlugin = createValidationPlugin<FieldData>({
  validate: (data: FieldData) => {
    // Validate only if field is visible
    if (data.meta?.visible === false) {
      return true;
    }
    
    return data.required && !data.value 
      ? 'This field is required' 
      : true;
  },
});
```
