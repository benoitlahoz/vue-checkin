# Form Example - Validation de formulaire

Exemple d'utilisation avec un formulaire et plugin de validation personnalisé.

## Démo interactive

::form-example
::

## Vue d'ensemble

Cet exemple illustre :
- L'utilisation du **ValidationPlugin** pour valider les données
- La création de règles de validation personnalisées
- La gestion d'erreurs par champ
- La validation en temps réel
- La soumission conditionnelle du formulaire

## Architecture

### Composant Parent : `FormExample.vue`

Le composant parent crée un desk avec un plugin de validation.

```vue
<script setup lang="ts">
import { useCheckIn, createValidationPlugin } from '@/vue-checkin/composables/useCheckIn';
import FormField from './FormField.vue';
import { FORM_DESK_KEY } from './index';

interface FieldData {
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
}

// Plugin de validation personnalisé
const validationPlugin = createValidationPlugin<FieldData>({
  validate: (data: FieldData) => {
    // Vérifier si le champ est requis
    if (data.required && !data.value) {
      return 'Ce champ est requis';
    }
    
    // Vérifier le format email
    if (data.type === 'email' && data.value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(data.value)) {
        return 'Email invalide';
      }
    }
    
    return true;
  },
});

// Créer un desk avec validation
const { createDesk } = useCheckIn<FieldData>();
const { desk } = createDesk(FORM_DESK_KEY, {
  debug: true,
  plugins: [validationPlugin],
});

// Typage étendu pour les méthodes du plugin
type DeskWithValidation = typeof desk & {
  isValid?: Ref<boolean>;
  getErrors?: () => Record<string | number, string>;
};

const deskWithValidation = desk as DeskWithValidation;
</script>
```

### Composant Enfant : `FormField.vue`

Chaque champ s'enregistre et synchronise ses données pour la validation.

```vue
<script setup lang="ts">
import { useCheckIn } from '@/vue-checkin/composables/useCheckIn';
import { FORM_DESK_KEY } from './index';

interface FormField {
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
}

const props = defineProps<{
  id: string | number;
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
  error?: string;
}>();

// Auto check-in avec watch des données
useCheckIn<FormField>().checkIn(FORM_DESK_KEY, {
  id: props.id,
  autoCheckIn: true,
  watchData: true,
  data: () => ({
    label: props.label,
    value: props.value,
    type: props.type,
    required: props.required,
  }),
});
</script>

<template>
  <div class="form-field">
    <label :for="String(id)" class="label">
      {{ label }}
      <span v-if="required" class="required">*</span>
    </label>
    <UInput
      :id="String(id)"
      :model-value="value"
      :type="type"
      :placeholder="`Entrez ${label.toLowerCase()}`"
      @update:model-value="$emit('update', id, $event)"
    />
    <span v-if="error" class="error">
      {{ error }}
    </span>
  </div>
</template>
```

### InjectionKey : `index.ts`

```typescript
import type { InjectionKey } from 'vue';
import type { CheckInDesk } from '@/vue-checkin/composables/useCheckIn';

interface FieldData {
  label: string;
  value: string;
  type: 'text' | 'email' | 'number';
  required: boolean;
}

export const FORM_DESK_KEY: InjectionKey<CheckInDesk<FieldData>> = Symbol('formDesk');

export { default as FormExample } from './FormExample.vue';
export { default as FormField } from './FormField.vue';
```

## ValidationPlugin

### Méthodes ajoutées

- `isValid`: Ref booléen indiquant si tous les champs sont valides
- `getErrors()`: Retourne un objet avec les erreurs par champ ID

### Fonction de validation

```typescript
const validationPlugin = createValidationPlugin<FieldData>({
  validate: (data: FieldData) => {
    // Retourner true si valide
    if (isValid(data)) {
      return true;
    }
    
    // Retourner un message d'erreur si invalide
    return 'Message d\'erreur';
  },
});
```

## Fonctionnalités

### Validation en temps réel

```typescript
const isFormValid = computed(() => deskWithValidation.isValid?.value ?? false);
const errors = computed(() => deskWithValidation.getErrors?.() || {});
```

Chaque modification de champ déclenche automatiquement la validation.

### Mise à jour d'un champ

```typescript
const updateFieldValue = (id: string, value: string) => {
  const field = fieldsData.value.find(f => f.id === id);
  if (field) {
    field.value = value;
  }
};
```

Grâce à `watchData: true`, la validation est déclenchée automatiquement.

### Soumission du formulaire

```typescript
const submitForm = () => {
  if (isFormValid.value) {
    const formData = fieldsData.value.reduce((acc, field) => {
      acc[field.id] = field.value;
      return acc;
    }, {} as Record<string, string>);

    alert('Formulaire soumis avec succès!\n\n' + JSON.stringify(formData, null, 2));
  } else {
    alert('Le formulaire contient des erreurs. Veuillez les corriger.');
  }
};
```

### Réinitialisation

```typescript
const resetForm = () => {
  fieldsData.value.forEach((field) => {
    field.value = '';
  });
};
```

## Règles de validation

### Champ requis

```typescript
if (data.required && !data.value) {
  return 'Ce champ est requis';
}
```

### Format email

```typescript
if (data.type === 'email' && data.value) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(data.value)) {
    return 'Email invalide';
  }
}
```

### Validation personnalisée

```typescript
// Nombre minimum
if (data.type === 'number' && data.value) {
  const num = parseInt(data.value);
  if (num < 18) {
    return 'Vous devez avoir au moins 18 ans';
  }
}

// Longueur minimale
if (data.value.length < 3) {
  return 'Minimum 3 caractères';
}

// Pattern personnalisé
if (!/^[A-Z]/.test(data.value)) {
  return 'Doit commencer par une majuscule';
}
```

## Concepts clés

::alert{type="info"}
**Validation réactive** : La validation se déclenche automatiquement à chaque modification grâce à `watchData`.
::

::alert{type="info"}
**État global** : `isValid` et `getErrors()` fournissent l'état de validation complet du formulaire.
::

::alert{type="success"}
**Règles personnalisées** : Le plugin accepte n'importe quelle fonction de validation.
::

## Utilisation

```vue
<template>
  <FormExample />
</template>

<script setup lang="ts">
import { FormExample } from '@/components/examples/form-example';
</script>
```

## Points d'attention

- La validation se déclenche à chaque modification de données
- `isValid` est `true` uniquement si **tous** les champs sont valides
- Les erreurs sont indexées par l'ID du champ
- La fonction `validate` doit retourner `true` ou un message d'erreur (string)
- Combinez avec d'autres plugins pour ajouter des fonctionnalités (historique, etc.)

## Extension

### Validation asynchrone

```typescript
const asyncValidationPlugin = createValidationPlugin<FieldData>({
  validate: async (data: FieldData) => {
    if (data.type === 'email') {
      const exists = await checkEmailExists(data.value);
      if (exists) {
        return 'Cet email est déjà utilisé';
      }
    }
    return true;
  },
});
```

### Validation conditionnelle

```typescript
const conditionalPlugin = createValidationPlugin<FieldData>({
  validate: (data: FieldData) => {
    // Valider uniquement si le champ est visible
    if (data.meta?.visible === false) {
      return true;
    }
    
    return data.required && !data.value 
      ? 'Ce champ est requis' 
      : true;
  },
});
```
